# Consul-replicate Agent (Upstart unit)
description "Consul-replicate Agent"
start on runlevel [2345]
stop on runlevel [!2345]
setuid <%= scope.lookupvar('consul_replicate::user') %>
setgid <%= scope.lookupvar('consul_replicate::group') %>
chdir <%= scope.lookupvar('consul_replicate::bin_dir') %>

respawn
respawn limit 5 20
kill timeout 10

script
	if [ -n "<%= scope.lookupvar('consul_replicate::populate_hash::acl_token') %>" ]; then
		TOKEN_PARAM="-token <%= scope.lookupvar('consul_replicate::populate_hash::acl_token') %>"
	fi
	exec consul lock -verbose $TOKEN_PARAM locks/replicate consul-replicate -config <%= scope.lookupvar('consul_replicate::config_dir') %> -log-level debug
end script

# `respawn limit` is set to 5 tries within 20 seconds so if the process restarts
# more than 5 times within this time frame it will remain stopped.
# This behavior is intentional to prevent false-negatives on monitoring applications
post-stop exec sleep 3
